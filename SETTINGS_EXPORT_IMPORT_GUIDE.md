# 设置导出导入功能使用指南

## 功能概述

本次更新实现了以下功能：

1. **全局设置抽屉** - 可以从应用的任何位置打开设置抽屉
2. **底部导航快捷访问** - 点击底部导航"定义User名称"直接打开设置的常规标签
3. **完整数据导出** - 导出所有本地配置，包括AI模型、Provider、用户设置等
4. **智能数据导入** - 导入配置文件后自动恢复所有设置并同步到数据库

## 如何使用

### 1. 打开设置

有两种方式打开设置抽屉：

#### 方式一：顶部导航栏（桌面端）
- 点击顶部导航栏的"设置"按钮
- 默认打开"模型"标签页

#### 方式二：底部导航栏（移动端）
- 点击底部导航栏的"定义User名称"按钮
- 自动打开设置抽屉的"常规"标签页
- 可以在这里设置用户名和绑定邮箱

### 2. 导出配置

1. 打开设置抽屉，切换到"常规"标签
2. 在页面底部找到"导出"按钮
3. 点击"导出"按钮
4. 浏览器会自动下载一个JSON文件，文件名格式：`sillytavern-backup-{时间戳}.json`

#### 导出的数据包括：

- **用户信息**：用户名、邮箱
- **应用设置**：语言、主题、字体大小等
- **AI模型配置**：所有已保存的AI模型（包括API Key、Base URL等）
- **Provider配置**：所有供应商的配置信息
- **聊天设置**：流式输出、快速模式等
- **创意设置**：创意模式相关配置
- **正则脚本**：所有自定义的正则表达式脚本
- **其他本地设置**

### 3. 导入配置

#### 使用场景：
- 更换新设备
- 重装浏览器
- 分享配置给其他用户
- 备份恢复

#### 导入步骤：

1. 打开设置抽屉，切换到"常规"标签
2. 在页面底部找到"导入"按钮
3. 点击"导入"按钮
4. 选择之前导出的JSON文件
5. 等待导入完成
6. 系统会自动刷新页面以应用所有配置

#### 导入过程：

1. **验证文件格式** - 检查文件是否是有效的备份文件
2. **恢复本地存储** - 将所有配置写入localStorage
3. **同步用户信息** - 自动调用API更新用户名和邮箱到数据库
4. **刷新应用** - 重新加载页面以应用所有更改

### 4. 注意事项

#### 数据安全：
- 导出的文件包含API Key等敏感信息，请妥善保管
- 不要将包含敏感信息的备份文件分享给他人
- 建议定期导出备份，以防数据丢失

#### 兼容性：
- 导出文件版本：v1.0.0
- 建议使用相同或更高版本的应用导入

#### 用户信息同步：
- 导入时会自动将用户名和邮箱同步到当前账号
- 如果同步失败，本地配置仍会正常恢复
- 可以手动在"常规"标签重新设置用户信息

## 技术实现

### 全局状态管理

创建了 `settingsUIStore` 来管理设置抽屉的全局状态：

```typescript
// src/stores/settingsUIStore.ts
interface SettingsUIState {
  isOpen: boolean
  defaultTab: string
  openSettings: (tab?: string) => void
  closeSettings: () => void
}
```

### 导出数据格式

```json
{
  "version": "1.0.0",
  "timestamp": "2025-10-31T12:00:00.000Z",
  "user": {
    "username": "用户名",
    "email": "email@example.com"
  },
  "localStorage": {
    "app_settings": "...",
    "ai-models-storage": "...",
    "provider-configs-storage": "...",
    ...
  },
  "metadata": {
    "exportedFrom": "localhost",
    "userAgent": "..."
  }
}
```

### 导入流程

1. 读取并解析JSON文件
2. 验证数据格式和版本
3. 恢复所有localStorage数据
4. 调用 `/api/users/current` PATCH 接口同步用户信息
5. 刷新页面触发所有store的rehydrate

## 测试建议

### 基本功能测试：

1. ✅ 点击底部导航"定义User名称"能打开设置抽屉
2. ✅ 设置抽屉默认显示"常规"标签
3. ✅ 可以设置用户名和邮箱
4. ✅ 导出功能正常工作
5. ✅ 导入功能正常工作

### 完整流程测试：

1. 在浏览器A中配置所有设置（AI模型、用户信息等）
2. 导出配置文件
3. 在浏览器B中导入配置文件
4. 验证所有配置都已正确恢复
5. 验证用户名和邮箱已同步到数据库

### 边界情况测试：

- 导入无效的JSON文件
- 导入旧版本的配置文件
- 网络异常时导入（用户信息同步失败）
- 导入空配置文件

## 更新日志

### 2025-10-31

- ✅ 创建全局设置抽屉状态管理 (`settingsUIStore`)
- ✅ 更新底部导航，支持点击打开设置抽屉
- ✅ 更新顶部导航，使用全局状态
- ✅ 完善导出功能，支持所有本地数据导出
- ✅ 完善导入功能，支持数据恢复和数据库同步
- ✅ 更新主布局，集成全局设置抽屉
- ✅ 所有功能通过构建测试

## 未来改进

- [ ] 支持选择性导出（让用户选择要导出的数据类型）
- [ ] 支持加密导出（保护敏感信息）
- [ ] 支持云端备份（自动同步到服务器）
- [ ] 支持配置版本管理（查看历史版本，回滚配置）
- [ ] 支持配置分享（生成分享链接）

