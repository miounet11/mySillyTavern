# AI 模型检查修复 - 测试指南

## 修复内容总结

已完成以下修复：

1. ✅ 在 `MessageInput.tsx` 中添加了 AI 模型配置检查
2. ✅ 在消息输入区域上方显示当前激活的 AI 模型信息
3. ✅ 发送按钮在没有配置模型时会被禁用
4. ✅ 尝试发送消息时会检查模型配置，并自动打开设置抽屉

## 测试场景

### 场景 1：无 AI 模型配置

**测试步骤：**
1. 清空浏览器 localStorage（或使用隐私模式）
2. 打开应用
3. 进入聊天页面

**预期结果：**
- ✅ 消息输入框上方**不显示**模型信息横幅
- ✅ 发送按钮应该是**禁用状态**（灰色）
- ✅ 如果尝试点击发送，应该看到错误提示：**"请先配置 AI 模型"**
- ✅ 应该**自动打开右侧设置抽屉**

### 场景 2：已配置 AI 模型

**测试步骤：**
1. 打开右侧设置抽屉
2. 在"AI 模型管理"中添加一个模型（例如：OpenAI - GPT-4）
3. 确保模型处于激活状态
4. 返回聊天页面

**预期结果：**
- ✅ 消息输入框上方应该显示**蓝紫色渐变横幅**
- ✅ 横幅中显示：**"当前模型: OpenAI - gpt-4"**（或你配置的模型）
- ✅ 横幅右侧显示：**"已激活"** 绿色标签，带闪烁的绿点
- ✅ 发送按钮应该是**可用状态**（蓝色渐变）
- ✅ 可以正常输入并发送消息

### 场景 3：切换 AI 模型

**测试步骤：**
1. 在已有模型的情况下，打开设置抽屉
2. 添加第二个 AI 模型
3. 激活第二个模型（这会自动取消第一个模型的激活状态）
4. 观察聊天界面

**预期结果：**
- ✅ 模型信息横幅应该**立即更新**为新激活的模型
- ✅ 显示格式：**"提供商名称 - 模型名称"**
- ✅ 绿色"已激活"标签持续显示
- ✅ 可以正常发送消息

### 场景 4：删除激活的模型

**测试步骤：**
1. 在设置中删除当前激活的 AI 模型
2. 返回聊天页面

**预期结果：**
- ✅ 模型信息横幅应该**消失**
- ✅ 发送按钮变为**禁用状态**
- ✅ 尝试发送消息时显示错误提示并打开设置抽屉

### 场景 5：重新生成功能

**测试步骤：**
1. 在无模型配置的情况下
2. 尝试点击"重新生成"按钮

**预期结果：**
- ✅ 应该显示错误提示：**"请先配置 AI 模型"**
- ✅ 自动打开设置抽屉
- ✅ 不会尝试执行生成操作

## 验证点清单

### UI 显示
- [ ] 模型信息横幅在有模型时正确显示
- [ ] 模型信息横幅在无模型时不显示
- [ ] 显示格式正确：**"提供商 - 模型名称"**
- [ ] 绿色"已激活"标签正确显示
- [ ] 横幅样式美观（蓝紫渐变背景，蓝色边框）

### 功能逻辑
- [ ] 无模型时发送按钮被禁用
- [ ] 有模型时发送按钮可用
- [ ] 无模型时点击发送显示错误提示
- [ ] 错误提示后自动打开设置抽屉
- [ ] 切换模型时信息实时更新
- [ ] 重新生成功能受到同样的限制

### 边界情况
- [ ] 首次进入应用（无任何配置）
- [ ] 模型配置不完整（缺少 API Key）
- [ ] 网络断开时的表现
- [ ] 快速切换模型时的表现

## 代码修改总结

### MessageInput.tsx 修改内容

1. **导入新的 hooks**（第 10-11 行）：
   ```typescript
   import { useModelGuard } from '@/hooks/useModelGuard'
   import { useAIModelStore } from '@/stores/aiModelStore'
   ```

2. **使用 hooks**（第 60-61 行）：
   ```typescript
   const { isModelReady, assertModelReady } = useModelGuard()
   const { activeModel } = useAIModelStore()
   ```

3. **在 handleSend 中添加检查**（第 118-123 行）：
   ```typescript
   // 检查模型是否已配置
   if (!isModelReady) {
     toast.error('请先配置 AI 模型')
     assertModelReady() // 自动打开设置抽屉
     return
   }
   ```

4. **添加模型信息显示**（第 285-301 行）：
   ```typescript
   {/* AI Model Info Banner */}
   {activeModel && (
     <div className="mb-3 px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-400/20 backdrop-blur-sm">
       {/* ... 模型信息显示 ... */}
     </div>
   )}
   ```

5. **更新发送按钮 disabled 条件**（第 498-505 行）：
   ```typescript
   disabled={
     disabled ||
     isLoading ||
     isRecording ||
     !message.trim() ||
     !currentCharacter ||
     !isModelReady  // 新增
   }
   ```

## 测试完成后

完成所有测试场景后，请确认：
- ✅ 所有预期结果都符合
- ✅ 没有发现新的 bug
- ✅ UI 显示美观且一致
- ✅ 用户体验流畅

如果发现任何问题，请记录并报告。

