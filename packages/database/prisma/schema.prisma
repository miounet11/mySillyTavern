// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User table - stores user information
model User {
  id        String   @id @default(cuid())
  username  String   // Auto-generated, can be modified by user
  email     String?  @unique // Optional, for account recovery
  settings  String?  // JSON string for user settings (theme, language, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  characters   Character[]
  aiModels     AIModelConfig[]
  promptTemplates PromptTemplate[]

  @@index([email])
  @@index([createdAt])
}

// Chats table - stores chat sessions
model Chat {
  id          String   @id @default(cuid())
  title       String
  characterId String
  userId      String?  @default("default")
  settings    String?  // JSON string for chat settings
  isFavorite  Boolean  @default(false)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  messages  Message[]
  branches  ChatBranch[]

  @@index([characterId])
  @@index([userId])
  @@index([updatedAt])
  @@index([isFavorite])
  @@index([isArchived])
}

// Messages table - stores chat messages
model Message {
  id        String   @id @default(cuid())
  chatId    String
  role      String   // 'user', 'assistant', 'system'
  content   String
  metadata  String?  // JSON string for message metadata
  timestamp DateTime @default(now())
  branchId  String?  // If message belongs to a specific branch

  // Relations
  chat    Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  branch  ChatBranch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  @@index([chatId])
  @@index([chatId, timestamp])
  @@index([branchId])
}

// Chat branches table - stores conversation branches
model ChatBranch {
  id          String   @id @default(cuid())
  parentId    String?  // Parent branch ID
  chatId      String
  branchPoint String   // Message ID where branch starts
  title       String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  chat     Chat      @relation(fields: [chatId], references: [id], onDelete: Cascade)
  parent   ChatBranch? @relation("BranchHierarchy", fields: [parentId], references: [id])
  children ChatBranch[] @relation("BranchHierarchy")
  messages Message[]

  @@index([chatId])
  @@index([parentId])
  @@index([isActive])
}

// Characters table - stores AI character definitions
model Character {
  id                String   @id @default(cuid())
  name              String
  userId            String   // Owner of this character
  description       String?
  personality       String?
  scenario          String?  // V2 field
  firstMessage      String?
  mesExample        String?  // V2 field: example messages
  avatar            String?  // Path to avatar file
  background        String?
  exampleMessages   String?  // JSON array (legacy)
  tags              String?  // JSON array
  creatorNotes      String?  // V2 field
  systemPrompt      String?  // V2 field
  postHistoryInstructions String?  // V2 field
  alternateGreetings String?  // V2 field: JSON array
  characterBook     String?  // V2 field: JSON object for world info
  creator           String?  // V2 field
  characterVersion  String?  // V2 field
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  settings          String?  // JSON string for character settings

  // Relations
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  chats         Chat[]
  worldInfos    WorldInfoCharacter[]
  pluginSettings PluginSetting[]

  @@unique([userId, name])
  @@index([userId])
  @@index([name])
  @@index([createdAt])
}

// World Info table - stores world information entries
model WorldInfo {
  id             String   @id @default(cuid())
  name           String
  content        String
  keywords       String?  // JSON array
  activationType String   // 'always', 'keyword', 'vector'
  priority       Int      @default(100)
  position       Int      @default(4)  // V2 field: insertion position (0-100)
  depth          Int      @default(4)  // V2 field: scan depth
  enabled        Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  settings       String?  // JSON string for world info settings

  // Relations
  characters WorldInfoCharacter[]
  vectors    WorldInfoVector[]

  @@index([activationType])
  @@index([enabled])
  @@index([priority])
}

// World Info and Character relationship
model WorldInfoCharacter {
  worldInfoId String
  characterId String

  // Relations
  worldInfo WorldInfo @relation(fields: [worldInfoId], references: [id], onDelete: Cascade)
  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@id([worldInfoId, characterId])
}

// World Info vectors table - stores vector embeddings for semantic search
model WorldInfoVector {
  id         String   @id @default(cuid())
  worldInfoId String
  embedding  String   // JSON array of vector data
  text       String   // Original text for embedding
  createdAt  DateTime @default(now())

  // Relations
  worldInfo WorldInfo @relation(fields: [worldInfoId], references: [id], onDelete: Cascade)

  @@index([worldInfoId])
}

// AI Model Configs table - stores AI model configurations
model AIModelConfig {
  id        String   @id @default(cuid())
  name      String
  userId    String   // Owner of this AI model config
  provider  String   // 'openai', 'anthropic', 'local', etc.
  model     String
  apiKey    String?  // Encrypted API key
  baseUrl   String?  // Custom base URL for local models
  settings  String?  // JSON string for model settings
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@index([provider])
  @@index([isActive])
}

// Plugins table - stores installed plugins
model Plugin {
  id          String   @id @default(cuid())
  name        String   @unique
  version     String
  description String?
  author      String?
  homepage    String?
  repository  String?
  license     String?
  keywords    String?  // JSON array
  enabled     Boolean  @default(false)
  config      String?  // JSON string for plugin config
  manifest    String   // JSON string for plugin manifest
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  settings PluginSetting[]

  @@index([enabled])
  @@index([name])
}

// Plugin Settings table - stores plugin configuration per scope
model PluginSetting {
  id        String   @id @default(cuid())
  pluginId  String
  scopeType String   // 'global', 'character', 'chat'
  scopeId   String?  // characterId, chatId, or null for global
  config    String   // JSON string for scope-specific config
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plugin    Plugin    @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  character Character? @relation(fields: [scopeId], references: [id], onDelete: Cascade)

  @@index([pluginId])
  @@index([scopeType, scopeId])
  @@index([enabled])
}

// User Settings table - for future user system implementation
model UserSetting {
  id        String   @id @default("default")
  theme     String   @default("dark")
  language  String   @default("en")
  uiSettings String? // JSON string for UI settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([id])
}

// System Logs table - for application logging
model SystemLog {
  id        String   @id @default(cuid())
  level     String   // 'error', 'warn', 'info', 'debug'
  message   String
  metadata  String?  // JSON string for log metadata
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([level])
}

// File Storage table - tracks uploaded files
model FileStorage {
  id           String   @id @default(cuid())
  originalName String
  filename     String   @unique
  mimeType     String
  size         Int
  path         String   // Storage path
  hash         String?  // File hash for deduplication
  uploadedBy   String?  @default("default")
  createdAt    DateTime @default(now())

  @@index([filename])
  @@index([mimeType])
  @@index([uploadedBy])
  @@index([hash])
}

// Prompt Templates table - stores reusable prompt templates
model PromptTemplate {
  id          String   @id @default(cuid())
  name        String
  content     String   // Template content with placeholders
  category    String   // 'external' for external prompts, 'variable' for template variables
  description String?  // Optional description
  isBuiltin   Boolean  @default(false) // Whether it's a system preset
  userId      String?  // User who created (null for builtin)
  isFavorite  Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([userId])
  @@index([isBuiltin])
  @@index([isFavorite])
}

// Community Characters table - stores community shared character cards
model CommunityCharacter {
  id            String   @id @default(cuid())
  name          String
  description   String?
  characterData String   // Full SillyTavern v2 character card JSON
  avatar        String?
  author        String
  authorId      String?  @default("default")
  downloads     Int      @default(0)
  likes         Int      @default(0)
  tags          String?  // JSON array
  category      String   @default("cards") // cards, popular, new, etc.
  isPublished   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
  @@index([category])
  @@index([isPublished])
  @@index([author])
  @@index([downloads])
}