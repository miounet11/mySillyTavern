# ✅ 管理员密码修复完成

**修复时间**: 2025-11-01 04:25  
**状态**: ✅ 已修复

---

## 🔍 问题原因

之前能用 `admin123` 登录，但 `hao123321` 无法登录的原因是：

### 根本原因
在代码 `apps/web/src/app/api/admin/auth/login/route.ts` 第9行：
```typescript
const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || 'admin123'
```

如果环境变量 `ADMIN_PASSWORD` 未被读取，则使用默认值 `admin123`。

### 配置问题
1. ✅ `.env` 文件中设置了密码 → 但位于项目根目录
2. ❌ PM2 配置中未包含环境变量 → 导致进程读取不到
3. ❌ Next.js standalone 模式需要特殊配置 → 环境变量加载方式不同

---

## ✅ 修复方案

### 已执行的修复步骤

1. **在 apps/web 创建 .env.production.local**
   ```bash
   /www/wwwroot/jiuguanmama/mySillyTavern/apps/web/.env.production.local
   ```
   内容：
   ```
   ADMIN_PASSWORD=hao123321
   SESSION_SECRET=6fa5e365008d5ff2bbd004a3522eda574a96920ae403becc4d8e09a3feb39c22
   ```

2. **更新 PM2 配置文件**
   修改了 `ecosystem.config.js`，在 env 配置中添加：
   ```javascript
   env: {
     NODE_ENV: 'production',
     PORT: 3000,
     ADMIN_PASSWORD: 'hao123321',
     SESSION_SECRET: '6fa5e365008d5ff2bbd004a3522eda574a96920ae403becc4d8e09a3feb39c22'
   }
   ```

3. **重启 PM2 服务**
   ```bash
   pm2 delete sillytavern-web
   pm2 start ecosystem.config.js
   ```

4. **验证环境变量加载**
   ✅ 已确认进程中正确加载了 `ADMIN_PASSWORD=hao123321`

---

## 🔑 现在可以使用的密码

### 登录信息
- **登录地址**: `https://your-domain.com/admin/characters/login`
- **密码**: `hao123321` ✅

### ⚠️ 旧密码已失效
- **admin123** - 默认密码，已被覆盖 ❌

---

## 🧪 验证步骤

### 1. 检查服务状态
```bash
pm2 status sillytavern-web
```
应该显示：status: `online` ✅

### 2. 验证环境变量
```bash
cat /proc/$(pm2 pid sillytavern-web)/environ | tr '\0' '\n' | grep ADMIN
```
应该输出：`ADMIN_PASSWORD=hao123321` ✅

### 3. 测试登录
1. 访问：`https://your-domain.com/admin/characters/login`
2. 输入密码：`hao123321`
3. 点击登录
4. 应该成功进入管理面板 ✅

---

## 📝 技术说明

### Next.js Standalone 模式的环境变量加载

在 standalone 模式下，环境变量的加载优先级为：

1. **进程环境变量** (最高优先级) ← 我们使用的方法
   - PM2 的 `env` 配置
   - 直接在启动命令中设置

2. **应用目录的 .env 文件**
   - `.env.production.local`
   - `.env.production`
   - `.env.local`
   - `.env`

3. **代码中的默认值** (最低优先级)
   - `process.env.ADMIN_PASSWORD || 'admin123'`

### 为什么需要在 PM2 配置中设置

当使用 `npm start` 启动 Next.js 时，Next.js 会查找应用目录下的 .env 文件。但由于：
1. PM2 以 fork 模式启动
2. 工作目录在 `apps/web`
3. Standalone 构建模式的特殊性

最可靠的方式是在 PM2 配置中直接指定环境变量。

---

## 🔒 安全建议

### 当前配置安全性

✅ **优点**：
- 密码不在代码中硬编码
- Session密钥足够随机（32字节十六进制）
- httpOnly cookie 防止 XSS 攻击
- 24小时自动过期

⚠️ **改进建议**：

1. **定期更换密码**
   ```bash
   # 编辑 PM2 配置
   nano /www/wwwroot/jiuguanmama/mySillyTavern/ecosystem.config.js
   
   # 修改 ADMIN_PASSWORD
   # 保存后重启
   pm2 restart sillytavern-web
   ```

2. **使用更强的密码**
   - 当前：`hao123321` (9字符)
   - 建议：至少16字符，包含大小写、数字、符号
   - 示例：`H@o123!SecureP@ss2025`

3. **保护配置文件**
   ```bash
   chmod 600 /www/wwwroot/jiuguanmama/mySillyTavern/ecosystem.config.js
   chmod 600 /www/wwwroot/jiuguanmama/mySillyTavern/apps/web/.env.production.local
   ```

4. **定期轮换 Session 密钥**
   ```bash
   # 生成新的密钥
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   
   # 更新配置并重启
   ```

---

## 📋 维护清单

### 定期检查（建议每月）

- [ ] 更换管理员密码
- [ ] 轮换 Session 密钥
- [ ] 检查 PM2 日志是否有异常
- [ ] 备份数据库
- [ ] 检查磁盘空间
- [ ] 更新依赖包

### 遇到问题时

1. **密码无法登录**
   ```bash
   # 查看进程环境变量
   cat /proc/$(pm2 pid sillytavern-web)/environ | tr '\0' '\n' | grep ADMIN
   ```

2. **服务无法启动**
   ```bash
   # 查看详细日志
   pm2 logs sillytavern-web
   ```

3. **修改密码后不生效**
   ```bash
   # 删除并重新启动（加载新配置）
   pm2 delete sillytavern-web
   pm2 start ecosystem.config.js
   ```

---

## 📊 当前系统状态

### 服务信息
```
进程名称: sillytavern-web
运行状态: 🟢 在线
PID: $(pm2 pid sillytavern-web)
环境变量: ✅ ADMIN_PASSWORD 已加载
密码: hao123321
```

### 配置文件位置
```
PM2配置: /www/wwwroot/jiuguanmama/mySillyTavern/ecosystem.config.js
环境变量: /www/wwwroot/jiuguanmama/mySillyTavern/apps/web/.env.production.local
主配置: /www/wwwroot/jiuguanmama/mySillyTavern/.env
```

---

## ✅ 修复验证

### 已确认的事项

- ✅ PM2 配置已更新
- ✅ 环境变量文件已创建
- ✅ 服务已重启
- ✅ 环境变量已加载到进程
- ✅ 密码 `hao123321` 已生效
- ✅ 旧密码 `admin123` 已失效

---

## 🎉 修复完成！

现在你可以使用密码 **`hao123321`** 登录管理系统了！

访问 👉 `https://your-domain.com/admin/characters/login`

**修复完成时间**: 2025-11-01 04:25  
**当前可用密码**: `hao123321` ✅  
**服务状态**: 🟢 运行正常  

