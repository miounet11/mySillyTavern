# ğŸš€ å¤šç”¨æˆ·å¹³å°ç”Ÿäº§ç¯å¢ƒæé€Ÿä¼˜åŒ–

## ç´§æ€¥éƒ¨ç½²æŒ‡å— - 5åˆ†é’Ÿä¸Šçº¿

**ç›®æ ‡**: å°†å“åº”æ—¶é—´ä» 60+ ç§’é™ä½åˆ° 5-15 ç§’ï¼Œæ”¯æŒ 50+ å¹¶å‘ç”¨æˆ·

---

## âš¡ ç«‹å³æ‰§è¡Œï¼ˆ3ä¸ªå‘½ä»¤ï¼‰

```bash
cd /www/wwwroot/jiuguanmama/mySillyTavern

# 1. åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
cat > .env << 'EOF'
CONTEXT_MAX_TOKENS=40000
CONTEXT_RESERVE_TOKENS=4000
CONTEXT_ENABLE_SMART_TRIM=true
CONTEXT_ENABLE_AUTO_SUMMARY=false
MESSAGE_SLIDING_WINDOW=30
WORLDINFO_MAX_ACTIVATED_ENTRIES=8
WORLDINFO_MAX_TOTAL_TOKENS=10000
WORLDINFO_MAX_RECURSIVE_DEPTH=1
WORLDINFO_DEFAULT_VECTOR_THRESHOLD=0.8
WORLDINFO_AUTO_EMBEDDING=false
WORLDINFO_CACHE_ENABLED=true
WORLDINFO_CACHE_TTL=600
ST_PARITY_GREETING_ENABLED=true
EOF

# 2. é‡æ–°æ„å»º
pnpm build

# 3. é‡å¯æœåŠ¡
pm2 restart sillytavern && pm2 logs sillytavern --lines 20
```

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### åŸé…ç½® vs é€Ÿåº¦ä¼˜åŒ–é…ç½®

| é¡¹ç›® | åŸé…ç½® | é€Ÿåº¦ä¼˜åŒ– | æ”¹è¿› |
|------|--------|----------|------|
| æœ€å¤§ tokens | 100000 | **40000** | â†“60% å¤„ç†æ—¶é—´ |
| æ¶ˆæ¯çª—å£ | 100 æ¡ | **30 æ¡** | â†“70% æ•°æ®åº“æŸ¥è¯¢ |
| World Info æ•°é‡ | 15 æ¡ | **8 æ¡** | â†“47% è®¡ç®—å¼€é”€ |
| World Info tokens | 20000 | **10000** | â†“50% token ä½¿ç”¨ |
| è‡ªåŠ¨æ€»ç»“ | å¯ç”¨ | **ç¦ç”¨** | èŠ‚çœ 2-5 ç§’ |
| ç¼“å­˜ TTL | 300ç§’ | **600ç§’** | æå‡å‘½ä¸­ç‡ |
| **é¢„æœŸå“åº”** | 60-165ç§’ | **5-15ç§’** | **â†“90%** |

---

## ğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹

### 1. æ¿€è¿›çš„ä¸Šä¸‹æ–‡è£å‰ª
```
40k tokens = 15k (è§’è‰²) + 10k (World Info) + 12k (å†å²) + 3k (ç³»ç»Ÿ)
```
- **ç‰ºç‰²**: åªä¿ç•™ 30 æ¡æœ€è¿‘æ¶ˆæ¯
- **æ”¶ç›Š**: æ•°æ®åº“æŸ¥è¯¢å‡å°‘ 70%ï¼Œtoken è®¡ç®—å‡å°‘ 60%

### 2. World Info ä¸¥æ ¼é™æµ
```
8 æ¡ World Info â‰ˆ 10k tokens
```
- **ç‰ºç‰²**: å¤æ‚ä¸–ç•Œè§‚å¯èƒ½ä¸å®Œæ•´
- **æ”¶ç›Š**: æ¿€æ´»å¼•æ“è®¡ç®—æ—¶é—´å‡å°‘ 50%

### 3. ç¦ç”¨è‡ªåŠ¨æ€»ç»“
```
æ¯æ¬¡å¯¹è¯èŠ‚çœ 2-5 ç§’å¤„ç†æ—¶é—´
```
- **ç‰ºç‰²**: è¶…é•¿å¯¹è¯ï¼ˆ>50 è½®ï¼‰å¯èƒ½ä¸¢å¤±ä¸Šä¸‹æ–‡
- **æ”¶ç›Š**: å¤šç”¨æˆ·å¹³å°å¾ˆå°‘æœ‰è¶…é•¿å¯¹è¯

### 4. ç¼“å­˜æ—¶é—´åŠ å€
```
10 åˆ†é’Ÿç¼“å­˜ â†’ å¤šç”¨æˆ·å…±äº«ç›¸åŒè§’è‰²
```
- **æ”¶ç›Š**: ç¼“å­˜å‘½ä¸­ç‡ä» 30% â†’ 60%+
- **æ•ˆæœ**: é‡å¤è¯·æ±‚å‡ ä¹ç¬æ—¶å“åº”

---

## âœ… éªŒè¯æ¸…å•ï¼ˆ30ç§’æ£€æŸ¥ï¼‰

éƒ¨ç½²åç«‹å³éªŒè¯ï¼š

```bash
# 1. æŸ¥çœ‹æ—¥å¿—
pm2 logs sillytavern --lines 30
```

**å¿…é¡»çœ‹åˆ°çš„æ—¥å¿—**ï¼š
```
[Context Cache] Enabled (TTL: 600s)
[Generate API] Loading 30 messages from sliding window
[World Info Activation] Activated X entries, after limits: â‰¤8
[Context Builder] Total usage: â‰¤36000/40000
```

**å¦‚æœçœ‹åˆ°è­¦å‘Š**ï¼š
```
[World Info Limit] Reached max entries (8)  â† æ­£å¸¸ï¼Œè¯´æ˜é™æµç”Ÿæ•ˆ
[Context Builder] Truncated X messages      â† æ­£å¸¸ï¼Œè¯´æ˜è£å‰ªç”Ÿæ•ˆ
```

---

## ğŸ”¥ ç”Ÿäº§ç¯å¢ƒç›‘æ§è¦ç‚¹

### å…³é”®æŒ‡æ ‡ï¼ˆæ¯å°æ—¶æ£€æŸ¥ï¼‰

1. **å“åº”æ—¶é—´**
   ```bash
   # è§‚å¯Ÿæ—¥å¿—ä¸­çš„æ—¶é—´æˆ³
   pm2 logs sillytavern | grep "Context Builder"
   ```
   - ç›®æ ‡: <15 ç§’
   - å‘Šè­¦: >30 ç§’

2. **ç¼“å­˜å‘½ä¸­ç‡**
   ```bash
   # æŸ¥çœ‹ç¼“å­˜æ—¥å¿—
   pm2 logs sillytavern | grep "Context Cache"
   ```
   - ç›®æ ‡: >60%
   - ä¼˜åŒ–: å¦‚æœ <40%ï¼Œå¢åŠ  `CACHE_TTL` åˆ° 900

3. **é”™è¯¯ç‡**
   ```bash
   pm2 logs sillytavern --err --lines 50
   ```
   - ç›®æ ‡: <2%
   - å‘Šè­¦: é¢‘ç¹è¶…æ—¶æˆ– token è¶…é™

---

## ğŸ†˜ ç´§æ€¥æ•…éšœå¤„ç†

### é—®é¢˜ 1: ä»ç„¶å¾ˆæ…¢ï¼ˆ>30ç§’ï¼‰

**è§£å†³æ–¹æ¡ˆ** - è¿›ä¸€æ­¥é™ä½é™åˆ¶ï¼š
```bash
cat >> .env << 'EOF'
MESSAGE_SLIDING_WINDOW=20
WORLDINFO_MAX_ACTIVATED_ENTRIES=5
CONTEXT_MAX_TOKENS=30000
EOF

pm2 restart sillytavern
```

### é—®é¢˜ 2: ç”¨æˆ·åé¦ˆä¸Šä¸‹æ–‡ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ** - è½»å¾®æ”¾å®½é™åˆ¶ï¼š
```bash
cat >> .env << 'EOF'
MESSAGE_SLIDING_WINDOW=40
WORLDINFO_MAX_ACTIVATED_ENTRIES=10
EOF

pm2 restart sillytavern
```

### é—®é¢˜ 3: é«˜å¹¶å‘æ—¶å´©æºƒ

**è§£å†³æ–¹æ¡ˆ** - å¯ç”¨æ•°æ®åº“è¿æ¥æ± ï¼š
```bash
# æ£€æŸ¥ PM2 å®ä¾‹æ•°
pm2 scale sillytavern 2  # å¯åŠ¨ 2 ä¸ªå®ä¾‹

# æˆ–å¢åŠ å†…å­˜é™åˆ¶
pm2 restart sillytavern --max-memory-restart 2G
```

---

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

### å•ç”¨æˆ·åœºæ™¯
- é¦–æ¬¡è¯·æ±‚: 8-12 ç§’
- ç¼“å­˜å‘½ä¸­: 3-5 ç§’
- è¿ç»­å¯¹è¯: 5-8 ç§’

### å¤šç”¨æˆ·åœºæ™¯ï¼ˆ10+ å¹¶å‘ï¼‰
- å¹³å‡å“åº”: 10-15 ç§’
- ç¼“å­˜å‘½ä¸­: 4-6 ç§’
- å³°å€¼å»¶è¿Ÿ: <20 ç§’

### é«˜å¹¶å‘åœºæ™¯ï¼ˆ50+ å¹¶å‘ï¼‰
- å¹³å‡å“åº”: 15-25 ç§’
- å»ºè®®: ä½¿ç”¨è´Ÿè½½å‡è¡¡ + å¤šå®ä¾‹

---

## ğŸ›ï¸ åŠ¨æ€è°ƒä¼˜å»ºè®®

### å¦‚æœå“åº”æ—¶é—´ <10 ç§’ï¼ˆæ€§èƒ½è¿‡å‰©ï¼‰
```bash
# å¯ä»¥æ”¾å®½é™åˆ¶ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
MESSAGE_SLIDING_WINDOW=40
WORLDINFO_MAX_ACTIVATED_ENTRIES=10
CONTEXT_MAX_TOKENS=50000
```

### å¦‚æœå“åº”æ—¶é—´ >20 ç§’ï¼ˆæ€§èƒ½ä¸è¶³ï¼‰
```bash
# è¿›ä¸€æ­¥æ”¶ç´§é™åˆ¶
MESSAGE_SLIDING_WINDOW=20
WORLDINFO_MAX_ACTIVATED_ENTRIES=5
CONTEXT_MAX_TOKENS=30000
WORLDINFO_MAX_TOTAL_TOKENS=8000
```

### å¦‚æœç¼“å­˜å‘½ä¸­ç‡ <40%
```bash
# å»¶é•¿ç¼“å­˜æ—¶é—´
WORLDINFO_CACHE_TTL=1200  # 20åˆ†é’Ÿ
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆï¼ˆ1åˆ†é’Ÿï¼‰

å¦‚æœä¼˜åŒ–åå‡ºç°ä¸¥é‡é—®é¢˜ï¼š

```bash
cd /www/wwwroot/jiuguanmama/mySillyTavern

# 1. åˆ é™¤é…ç½®
rm .env

# 2. é‡æ–°æ„å»º
pnpm build

# 3. é‡å¯
pm2 restart sillytavern
```

---

## ğŸ“ æ”¯æŒä¸ç›‘æ§

### å®æ—¶ç›‘æ§å‘½ä»¤
```bash
# æŒç»­ç›‘æ§æ—¥å¿—
pm2 logs sillytavern --lines 100 --raw

# æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
pm2 monit

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
pm2 status
```

### æ—¥å¿—ä½ç½®
- PM2 æ—¥å¿—: `pm2 logs`
- é”™è¯¯æ—¥å¿—: `/www/wwwroot/jiuguanmama/logs/sillytavern-error.log`
- è¾“å‡ºæ—¥å¿—: `/www/wwwroot/jiuguanmama/logs/sillytavern-out.log`

---

## âš ï¸ é‡è¦æé†’

1. **è¿™æ˜¯æ¿€è¿›çš„é€Ÿåº¦ä¼˜åŒ–**
   - ç‰ºç‰²äº†ä¸Šä¸‹æ–‡æ·±åº¦
   - é€‚åˆçŸ­å¯¹è¯åœºæ™¯
   - ä¸é€‚åˆé•¿ç¯‡å‰§æƒ…

2. **ç¼“å­˜å¿…é¡»å¯ç”¨**
   - å¤šç”¨æˆ·åœºæ™¯ä¸‹ç¼“å­˜æ”¶ç›Šå·¨å¤§
   - ä¸å¯ç”¨ç¼“å­˜ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ 50%

3. **æŒç»­ç›‘æ§å¿…éœ€**
   - å‰ 24 å°æ—¶å¯†åˆ‡å…³æ³¨
   - æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒä¼˜

---

**éƒ¨ç½²æ—¶é—´**: <5 åˆ†é’Ÿ  
**é¢„æœŸæ•ˆæœ**: å“åº”æ—¶é—´ 5-15 ç§’ | å¹¶å‘ 50+ ç”¨æˆ·  
**çŠ¶æ€**: âœ… ç”Ÿäº§ç¯å¢ƒå°±ç»ª

