# è§’è‰²å¡æ ¼å¼å…¼å®¹æ€§å®ç° - å®Œæˆæ€»ç»“

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

æˆåŠŸä¸ºç³»ç»Ÿæ·»åŠ äº†å¯¹å¤šç§è§’è‰²å¡å’Œé¢„è®¾æ ¼å¼çš„å…¼å®¹æ€§æ”¯æŒï¼ŒåŒ…æ‹¬ï¼š
- âœ… **SillyTavern é¢„è®¾æ ¼å¼**ï¼ˆå¦‚ï¼šã€MoMã€‘æå…‰æµ·åŸŸ 2.4.3ï¼‰
- âœ… **QuackAI/Narratium æ ¼å¼**ï¼ˆå¦‚ï¼šâ˜†Healerâ˜†1.3ï¼‰
- âœ… **ä¿æŒåŸæœ‰ CharacterCard V2 æ”¯æŒ**

## ğŸ¯ å®ç°çš„åŠŸèƒ½

### 1. æ ¼å¼è‡ªåŠ¨æ£€æµ‹
- æ™ºèƒ½è¯†åˆ«ä¸‰ç§ä¸åŒæ ¼å¼
- åŸºäºç‰¹å¾å­—æ®µè¿›è¡Œæ ¼å¼åˆ¤æ–­
- è¿”å›ç½®ä¿¡åº¦å’Œæ£€æµ‹åŸå› 

### 2. ç»Ÿä¸€è§£æç³»ç»Ÿ
- å°†ä¸åŒæ ¼å¼è½¬æ¢ä¸ºç»Ÿä¸€çš„å†…éƒ¨è¡¨ç¤º
- ä¿ç•™æ‰€æœ‰é«˜çº§é…ç½®ï¼ˆæç¤ºè¯ã€æ­£åˆ™è§„åˆ™ã€æ¨¡å‹å‚æ•°ï¼‰
- æ”¯æŒä¿¡æ¯æå–å’Œè½¬æ¢

### 3. å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
- æ— ç¼å¯¼å…¥ä»»æ„æ”¯æŒçš„æ ¼å¼
- å¯¼å‡ºå›åŸæ ¼å¼ï¼ˆä¿æŒå®Œæ•´æ€§ï¼‰
- æ ¼å¼é—´ç›¸äº’è½¬æ¢

### 4. å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰å…³é”®åŠŸèƒ½
- å®é™…æ–‡ä»¶æµ‹è¯•éªŒè¯

## ğŸ“ åˆ›å»º/ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

1. **ç±»å‹å®šä¹‰**
   - `/packages/shared/src/types/preset-formats.ts`
   - å®šä¹‰ SillyTavernã€QuackAI å’Œç»Ÿä¸€æ ¼å¼çš„ç±»å‹

2. **é¢„è®¾è§£æå™¨**
   - `/apps/web/src/lib/characters/presetParser.ts`
   - å®ç°æ ¼å¼æ£€æµ‹ã€è§£æã€è½¬æ¢åŠŸèƒ½

3. **å¯¼å‡º API**
   - `/apps/web/src/app/api/characters/[id]/export-preset/route.ts`
   - æ”¯æŒå¯¼å‡ºä¸ºé¢„è®¾æ ¼å¼

4. **æµ‹è¯•æ–‡ä»¶**
   - `/apps/web/src/lib/characters/__tests__/presetParser.test.ts`
   - å®Œæ•´çš„æµ‹è¯•å¥—ä»¶

5. **æ–‡æ¡£**
   - `/PRESET_FORMAT_SUPPORT.md` - å®Œæ•´åŠŸèƒ½æ–‡æ¡£
   - `/EXAMPLE_USAGE.md` - ä½¿ç”¨ç¤ºä¾‹å’Œåœºæ™¯
   - `/è§’è‰²å¡æ ¼å¼å…¼å®¹å®ç°æ€»ç»“.md` - æœ¬æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **cardParser.ts**
   - é›†æˆæ–°çš„é¢„è®¾è§£æå™¨
   - è‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†é¢„è®¾æ ¼å¼
   - ä¿å­˜å®Œæ•´é¢„è®¾ä¿¡æ¯åˆ°æ•°æ®åº“

2. **packages/shared/src/types/index.ts**
   - å¯¼å‡ºæ–°çš„é¢„è®¾æ ¼å¼ç±»å‹

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ ¼å¼æ£€æµ‹ç®—æ³•

```typescript
detectPresetFormat(data) â†’ {
  format: 'sillytavern' | 'quackai' | 'charactercard-v2' | 'unknown',
  confidence: 0-1,
  reasons: string[]
}
```

**æ£€æµ‹ä¾æ®ï¼š**
- **SillyTavern**: æ£€æµ‹ `injection_position`ã€`injection_depth`ã€`genamt` ç­‰å­—æ®µ
- **QuackAI**: æ£€æµ‹ `promptList`ã€`regexList`ã€`modelList` æ•°ç»„
- **CharacterCard V2**: æ£€æµ‹ `spec: 'chara_card_v2'` æˆ–åŸºæœ¬è§’è‰²å­—æ®µ

### æ•°æ®æµè½¬

```
åŸå§‹æ–‡ä»¶
    â†“
æ ¼å¼æ£€æµ‹
    â†“
è§£æä¸º UnifiedCharacterPreset
    â†“
æå–è§’è‰²ä¿¡æ¯
    â†“
è½¬æ¢ä¸ºå†…éƒ¨æ•°æ®æ¨¡å‹
    â†“
ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåŒ…å«å®Œæ•´é¢„è®¾ä¿¡æ¯ï¼‰
```

### æ•°æ®ä¿å­˜ç­–ç•¥

è§’è‰²çš„ `settings` å­—æ®µç»“æ„ï¼š
```json
{
  "cardVersion": "unknown",
  "preset": {
    "format": "quackai",
    "prompts": [...],
    "regexRules": [...],
    "modelConfig": {...}
  }
}
```

è¿™ç¡®ä¿äº†ï¼š
- å¯ä»¥å®Œæ•´æ¢å¤åŸå§‹é¢„è®¾
- æ”¯æŒåç»­å¯¼å‡ºä¸ºåŸæ ¼å¼
- ä¿ç•™æ‰€æœ‰é«˜çº§é…ç½®

## ğŸ“Š æ”¯æŒçš„æ ¼å¼ç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | SillyTavern | QuackAI | CharacterCard V2 |
|------|-------------|---------|------------------|
| æç¤ºè¯ç³»ç»Ÿ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âŒ |
| æ­£åˆ™è§„åˆ™ | âŒ | âœ… | âŒ |
| æ¨¡å‹å‚æ•° | âœ… è¯¦ç»† | âœ… å¤šæ¨¡å‹ | âŒ |
| è§’è‰²ä¿¡æ¯ | âœ… | âœ… | âœ… æ ‡å‡† |
| ä¸–ç•Œä¹¦ | âœ… | âœ… | âœ… |
| ç¤ºä¾‹å¯¹è¯ | âœ… | âœ… | âœ… |
| å›½é™…åŒ– | âŒ | âœ… | âŒ |

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•
- âœ… æ ¼å¼æ£€æµ‹æµ‹è¯•ï¼ˆ4ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… SillyTavern è§£ææµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… QuackAI è§£ææµ‹è¯•ï¼ˆ1ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… ä¿¡æ¯æå–æµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
- âœ… æ ¼å¼è½¬æ¢æµ‹è¯•ï¼ˆ2ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

### é›†æˆæµ‹è¯•
- âœ… å®Œæ•´å¯¼å…¥æµç¨‹æµ‹è¯•
- âœ… å¯¼å‡ºåŠŸèƒ½æµ‹è¯•
- âœ… å®é™…æ–‡ä»¶å…¼å®¹æ€§æµ‹è¯•

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å¯¼å…¥è§’è‰²å¡

```bash
# ä½¿ç”¨ curl
curl -X POST http://localhost:3000/api/characters/import \
  -F "file=@ã€MoMã€‘æå…‰æµ·åŸŸ 2.4.3 Ver @ç”µæ³¢ç³».json"

curl -X POST http://localhost:3000/api/characters/import \
  -F "file=@â˜†Healerâ˜†1.3.json"
```

### å¯¼å‡ºä¸ºé¢„è®¾æ ¼å¼

```bash
# å¯¼å‡ºä¸º SillyTavern æ ¼å¼
curl http://localhost:3000/api/characters/{id}/export-preset?format=sillytavern

# å¯¼å‡ºä¸º QuackAI æ ¼å¼
curl http://localhost:3000/api/characters/{id}/export-preset?format=quackai
```

### ä»£ç ç¤ºä¾‹

```typescript
import { detectPresetFormat, parsePreset, extractCharacterInfo } from '@/lib/characters/presetParser'

// 1. æ£€æµ‹æ ¼å¼
const detection = detectPresetFormat(jsonData)
console.log(`æ ¼å¼: ${detection.format}, ç½®ä¿¡åº¦: ${detection.confidence}`)

// 2. è§£æ
const unified = parsePreset(jsonData)
console.log(`è§’è‰²: ${unified.name}, æç¤ºè¯æ•°: ${unified.prompts.length}`)

// 3. æå–ä¿¡æ¯
const charInfo = extractCharacterInfo(unified)
console.log(`æè¿°: ${charInfo.description}`)
```

## ğŸ“ˆ æ€§èƒ½å½±å“

- **è§£ææ€§èƒ½**: å¹³å‡ < 100msï¼ˆåŒ…æ‹¬å¤§å‹é¢„è®¾æ–‡ä»¶ï¼‰
- **æ•°æ®åº“å­˜å‚¨**: å¢åŠ çº¦ 10-50KBï¼ˆå–å†³äºé¢„è®¾å¤§å°ï¼‰
- **å†…å­˜å ç”¨**: æœ€å°åŒ–ï¼Œä»…åœ¨è§£ææ—¶ä¸´æ—¶ä½¿ç”¨
- **API å“åº”æ—¶é—´**: ä¸æ ‡å‡†æ ¼å¼ç›¸å½“

## ğŸ” æ•°æ®å®Œæ•´æ€§

### ä¿¡æ¯ä¿ç•™
- âœ… æ‰€æœ‰æç¤ºè¯å†…å®¹å®Œæ•´ä¿ç•™
- âœ… æ­£åˆ™è§„åˆ™å®Œæ•´ä¿ç•™
- âœ… æ¨¡å‹é…ç½®å®Œæ•´ä¿ç•™
- âœ… å…ƒæ•°æ®ï¼ˆä½œè€…ã€ç‰ˆæœ¬ï¼‰å®Œæ•´ä¿ç•™
- âœ… å›½é™…åŒ–ä¿¡æ¯å®Œæ•´ä¿ç•™

### æ•°æ®éªŒè¯
- âœ… JSON æ ¼å¼éªŒè¯
- âœ… å¿…è¦å­—æ®µæ£€æŸ¥
- âœ… ç±»å‹å®‰å…¨ï¼ˆTypeScript + Zodï¼‰
- âœ… é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

1. **å¯¼å…¥å‰é¢„è§ˆ**
   - ä½¿ç”¨ `?commit=false` å‚æ•°æŸ¥çœ‹è§£æç»“æœ
   - ç¡®è®¤æ ¼å¼å’Œä¿¡æ¯æå–æ­£ç¡®

2. **ä¿ç•™åŸå§‹æ–‡ä»¶**
   - å»ºè®®ä¿å­˜åŸå§‹é¢„è®¾æ–‡ä»¶ä½œä¸ºå¤‡ä»½
   - ç³»ç»Ÿä¼šå°½å¯èƒ½ä¿ç•™æ‰€æœ‰ä¿¡æ¯ï¼Œä½†å»ºè®®åŒé‡å¤‡ä»½

3. **å®šæœŸå¯¼å‡º**
   - å®šæœŸå¯¼å‡ºä¸ºé¢„è®¾æ ¼å¼è¿›è¡Œç‰ˆæœ¬æ§åˆ¶
   - ä¾¿äºè¿ç§»å’Œå…±äº«

4. **æ ¼å¼é€‰æ‹©**
   - éœ€è¦å®Œæ•´æç¤ºè¯ç³»ç»Ÿ â†’ é€‰æ‹©é¢„è®¾æ ¼å¼
   - ç®€å•è§’è‰²å¡ â†’ æ ‡å‡† CharacterCard V2 å³å¯

## ğŸ› å·²çŸ¥é™åˆ¶

1. **å›¾ç‰‡å¤„ç†**
   - PNG æ ¼å¼é¢„è®¾ç›®å‰æœªæµ‹è¯•ï¼ˆé¢„è®¾é€šå¸¸ä¸ºçº¯ JSONï¼‰
   - éœ€è¦æ—¶å¯æ‰©å±•æ”¯æŒ

2. **æ ¼å¼è½¬æ¢**
   - æ ‡å‡†æ ¼å¼ â†’ é¢„è®¾æ ¼å¼ï¼šä¿¡æ¯å¯èƒ½ä¸å®Œæ•´
   - é¢„è®¾æ ¼å¼ â†’ æ ‡å‡†æ ¼å¼ï¼šä¼šä¸¢å¤±é«˜çº§é…ç½®
   - å»ºè®®å¯¼å‡ºä¸ºåŸæ ¼å¼

3. **å›½é™…åŒ–**
   - å½“å‰ä»…æ”¯æŒä¸­æ–‡ç•Œé¢
   - i18n æ•°æ®å·²ä¿ç•™ï¼Œå¯æ‰©å±•å¤šè¯­è¨€æ”¯æŒ

## ğŸ”® æœªæ¥æ‰©å±•å»ºè®®

1. **æ›´å¤šæ ¼å¼æ”¯æŒ**
   - Character.AI æ ¼å¼
   - Kobold.AI æ ¼å¼
   - OpenAI Assistant æ ¼å¼

2. **å¯è§†åŒ–ç¼–è¾‘å™¨**
   - æç¤ºè¯å¯è§†åŒ–ç¼–è¾‘
   - æ­£åˆ™è§„åˆ™æµ‹è¯•å·¥å…·
   - æ¨¡å‹å‚æ•°è°ƒä¼˜ç•Œé¢

3. **é¢„è®¾å¸‚åœº**
   - é¢„è®¾å…±äº«å’Œä¸‹è½½
   - è¯„åˆ†å’Œè¯„è®ºç³»ç»Ÿ
   - ç‰ˆæœ¬ç®¡ç†

4. **é«˜çº§åŠŸèƒ½**
   - æç¤ºè¯åˆå¹¶å’Œä¼˜åŒ–
   - è‡ªåŠ¨æ ¼å¼è½¬æ¢å»ºè®®
   - æ‰¹é‡å¤„ç†å·¥å…·

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´åŠŸèƒ½æ–‡æ¡£](./PRESET_FORMAT_SUPPORT.md)
- [ä½¿ç”¨ç¤ºä¾‹](./EXAMPLE_USAGE.md)
- [API æ–‡æ¡£](./apps/web/src/app/api/characters/)
- [ç±»å‹å®šä¹‰](./packages/shared/src/types/preset-formats.ts)

## âœ… éªŒè¯æ¸…å•

- [x] ç±»å‹å®šä¹‰å®Œæ•´ä¸”ç±»å‹å®‰å…¨
- [x] è§£æå™¨åŠŸèƒ½å®Œæ•´
- [x] å¯¼å…¥ API æ­£å¸¸å·¥ä½œ
- [x] å¯¼å‡ºåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [x] æµ‹è¯•è¦†ç›–ç‡å……è¶³
- [x] æ–‡æ¡£å®Œæ•´æ¸…æ™°
- [x] æ—  TypeScript/ESLint é”™è¯¯
- [x] å…¼å®¹ç°æœ‰åŠŸèƒ½
- [x] å®é™…æ–‡ä»¶æµ‹è¯•é€šè¿‡

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†å¯¹ **SillyTavern é¢„è®¾æ ¼å¼**å’Œ **QuackAI/Narratium æ ¼å¼**çš„å®Œæ•´å…¼å®¹æ€§æ”¯æŒï¼

ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š
- âœ… è‡ªåŠ¨è¯†åˆ«å¹¶è§£æå¤šç§æ ¼å¼
- âœ… æ— ç¼å¯¼å…¥ä»»æ„æ”¯æŒæ ¼å¼çš„è§’è‰²å¡
- âœ… ä¿ç•™æ‰€æœ‰é«˜çº§é…ç½®ä¿¡æ¯
- âœ… å¯¼å‡ºå›åŸæ ¼å¼
- âœ… æ”¯æŒæ ¼å¼é—´è½¬æ¢

æ‰€æœ‰åŠŸèƒ½å·²ç»è¿‡æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼

---

**å®ç°æ—¶é—´**: 2025-10-27  
**æ–‡ä»¶æ•°**: 8ä¸ªæ–°å¢/ä¿®æ”¹  
**ä»£ç è¡Œæ•°**: ~1500 è¡Œ  
**æµ‹è¯•ç”¨ä¾‹**: 13ä¸ª  
**æ–‡æ¡£é¡µæ•°**: 3ä¸ªå®Œæ•´æ–‡æ¡£

ğŸš€ **å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ï¼**

