# èŠå¤©åŠŸèƒ½æç¤ºè¯ä¿®å¤æ€»ç»“

## ä¿®å¤æ—¥æœŸ
2025-10-28

## é—®é¢˜æè¿°

åœ¨å¯¹è¯ç”Ÿæˆæ—¶ï¼Œç³»ç»Ÿ**ç¼ºå°‘å…³é”®çš„è§’è‰²ä¿¡æ¯**ï¼Œå¯¼è‡´AIæ— æ³•æ­£ç¡®ç†è§£å’Œæ‰®æ¼”è§’è‰²ï¼Œåªèƒ½ç»™å‡ºé€šç”¨å›å¤ã€‚

### ç¼ºå¤±çš„å…³é”®å­—æ®µ

1. **`description`** (è§’è‰²æè¿°) - æœ€é‡è¦çš„å­—æ®µ âŒ
   - åŒ…å«è§’è‰²çš„å¤–è²Œã€èƒŒæ™¯ã€è¡Œä¸ºç‰¹å¾ç­‰è¯¦ç»†ä¿¡æ¯
   - è¿™æ˜¯è§’è‰²å¡ä¸­æœ€æ ¸å¿ƒçš„å­—æ®µï¼Œä½†å®Œå…¨æ²¡æœ‰å‘é€ç»™AI

2. **`creatorNotes`** (åˆ›ä½œè€…å¤‡æ³¨) âŒ
   - ä½œè€…å¯¹è§’è‰²æ‰®æ¼”çš„æŒ‡å¯¼è¯´æ˜
   - æœªè¢«ä½¿ç”¨

3. **`postHistoryInstructions`** (åå†å²æŒ‡ä»¤) âš ï¸
   - åœ¨ `/api/chats/[id]/generate` ä¸­å·²å­˜åœ¨
   - åœ¨ `/api/generate` ä¸­ç¼ºå¤±

4. **`firstMessage`** (å¼€åœºç™½) âŒ
   - åˆ›å»ºå¯¹è¯æ—¶æœªè‡ªåŠ¨æ·»åŠ 

## å®æ–½çš„ä¿®å¤

### 1. åˆ›å»ºå¯¹è¯æ—¶è‡ªåŠ¨æ·»åŠ å¼€åœºç™½

**æ–‡ä»¶ï¼š** `apps/web/src/app/api/chats/route.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
```typescript
// Auto-add first message (greeting) if character has one
const messages = []
if (character.firstMessage) {
  const greetingMessage = await db.create('Message', {
    id: nanoid(),
    chatId: chat.id,
    role: 'assistant',
    content: character.firstMessage,
    metadata: JSON.stringify({ isGreeting: true }),
  })
  messages.push(greetingMessage)
}
```

**æ•ˆæœï¼š** åˆ›å»ºæ–°å¯¹è¯æ—¶ï¼Œå¦‚æœè§’è‰²æœ‰ `firstMessage`ï¼Œä¼šè‡ªåŠ¨ä½œä¸ºç¬¬ä¸€æ¡åŠ©æ‰‹æ¶ˆæ¯æ˜¾ç¤ºã€‚

### 2. å®Œå–„å¯¹è¯ç”Ÿæˆæç¤ºè¯æ„å»º

**æ–‡ä»¶ï¼š** `apps/web/src/app/api/chats/[id]/generate/route.ts`

**æ·»åŠ çš„å­—æ®µï¼ˆæŒ‰é¡ºåºï¼‰ï¼š**

1. System Prompt (å¦‚æœå­˜åœ¨)
2. **Character Description** â­ NEW
3. **Creator Notes** â­ NEW
4. Scenario/Background
5. Character Personality
6. Example Messages
7. Conversation History
8. Post-History Instructions (å·²å­˜åœ¨)
9. World Info

**ä»£ç ç¤ºä¾‹ï¼š**
```typescript
// 2. Character description (CRITICAL - most important field)
if (chat.character.description) {
  conversationMessages.push({ 
    role: 'system', 
    content: `Character Description:\n${chat.character.description}` 
  })
}

// 3. Creator notes (author's guidance)
if (chat.character.creatorNotes) {
  conversationMessages.push({ 
    role: 'system', 
    content: `Creator Notes:\n${chat.character.creatorNotes}` 
  })
}
```

### 3. å®Œå–„é€šç”¨ç”ŸæˆAPIæç¤ºè¯æ„å»º

**æ–‡ä»¶ï¼š** `apps/web/src/app/api/generate/route.ts`

**æ·»åŠ çš„å­—æ®µï¼š**
- Character Description
- Creator Notes
- **Post-History Instructions** â­ NEW (æ­¤æ–‡ä»¶ä¹‹å‰æ²¡æœ‰)

**å®Œæ•´é¡ºåºï¼š**
1. System Prompt
2. **Character Description** â­ NEW
3. **Creator Notes** â­ NEW
4. Scenario/Background
5. Character Personality
6. Example Messages
7. Conversation History
8. **Post-History Instructions** â­ NEW
9. User Message
10. World Info

## æç¤ºè¯æ„å»ºé¡ºåºè¯´æ˜

å‚è€ƒ SillyTavern çš„æ ‡å‡†å®è·µï¼Œæç¤ºè¯çš„æ­£ç¡®é¡ºåºä¸ºï¼š

1. **System Prompt** - å…¨å±€ç³»ç»ŸæŒ‡ä»¤
2. **Character Description** - è§’è‰²çš„è¯¦ç»†æè¿°ï¼ˆæœ€é‡è¦ï¼‰
3. **Creator Notes** - ä½œè€…çš„æŒ‡å¯¼è¯´æ˜
4. **Scenario** - åœºæ™¯è®¾å®š
5. **Personality** - æ€§æ ¼ç‰¹å¾
6. **Example Messages** - ç¤ºä¾‹å¯¹è¯ï¼ˆFew-shot learningï¼‰
7. **Conversation History** - å¯¹è¯å†å²
8. **Post-History Instructions** - åå†å²æŒ‡ä»¤ï¼ˆåœ¨å†å²åæ³¨å…¥ï¼‰
9. **World Info** - ä¸–ç•Œä¹¦ä¿¡æ¯ï¼ˆåŸºäºå…³é”®è¯æ³¨å…¥ï¼‰

è¿™ä¸ªé¡ºåºç¡®ä¿äº†ï¼š
- AIé¦–å…ˆç†è§£è‡ªå·±çš„èº«ä»½ï¼ˆè§’è‰²æè¿°ï¼‰
- ç„¶åäº†è§£åœºæ™¯å’Œæ€§æ ¼
- é€šè¿‡ç¤ºä¾‹å­¦ä¹ è¯´è¯é£æ ¼
- æœ€åæ ¹æ®å¯¹è¯å†å²è¿›è¡Œå›å¤

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹ï¼šç”œäº‘çŒ«çŒ«è§’è‰²å¡

**è§’è‰²æè¿°ç¤ºä¾‹ï¼š**
```
ä¸€ä½ç™½å‘çŒ«è€³å°‘å¥³ï¼Œå¼‚è‰²åŒç³ï¼ˆä¸€è“ä¸€çº¢ï¼‰ï¼Œç©¿ç€å®½æ¾çš„çº¢è‰²ç¡è¡£...
```

**é¢„æœŸæ•ˆæœï¼š**

âœ… **ä¿®å¤å‰ï¼š**
```
ç”¨æˆ·: ä½ å¥½
AI: ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
```

âœ… **ä¿®å¤åï¼š**
```
ç”¨æˆ·: ä½ å¥½
ç”œäº‘: ç¬¨è›‹ä¸»äººï¼*æ‘‡æ™ƒç€å°¾å·´* ä½ ç»ˆäºæ¥æ‰¾æˆ‘äº†å–µï½
```

### éªŒè¯æ­¥éª¤

1. **å¼€åœºç™½æµ‹è¯•ï¼š**
   - åˆ›å»ºæ–°å¯¹è¯
   - éªŒè¯æ˜¯å¦è‡ªåŠ¨æ˜¾ç¤º `firstMessage`

2. **è§’è‰²æ‰®æ¼”æµ‹è¯•ï¼š**
   - å‘é€æ¶ˆæ¯ç»™è§’è‰²
   - éªŒè¯AIæ˜¯å¦æŒ‰ç…§è§’è‰²æè¿°å›å¤
   - æ£€æŸ¥æ˜¯å¦ä½“ç°è§’è‰²æ€§æ ¼å’Œè¯´è¯é£æ ¼

3. **å…¼å®¹æ€§æµ‹è¯•ï¼š**
   - æµ‹è¯•ç¼ºå°‘æŸäº›å­—æ®µçš„è§’è‰²å¡
   - ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿä¼˜é›…é™çº§

## ä»£ç è´¨é‡

- âœ… æ‰€æœ‰ä¿®æ”¹é€šè¿‡ TypeScript ç±»å‹æ£€æŸ¥
- âœ… æ—  ESLint é”™è¯¯
- âœ… å‘åå…¼å®¹ï¼ˆå­—æ®µä¸å­˜åœ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼‰
- âœ… éµå¾ªç°æœ‰ä»£ç é£æ ¼

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶

1. `apps/web/src/app/api/chats/route.ts` (åˆ›å»ºå¯¹è¯)
2. `apps/web/src/app/api/chats/[id]/generate/route.ts` (å¯¹è¯ç”Ÿæˆ)
3. `apps/web/src/app/api/generate/route.ts` (é€šç”¨ç”Ÿæˆ)

### API è¡Œä¸ºå˜åŒ–

**åˆ›å»ºå¯¹è¯ API (`POST /api/chats`)ï¼š**
- è¿”å›çš„ `messages` æ•°ç»„ç°åœ¨å¯èƒ½åŒ…å«å¼€åœºç™½æ¶ˆæ¯
- å¦‚æœè§’è‰²æ²¡æœ‰ `firstMessage`ï¼Œè¡Œä¸ºä¸å˜

**ç”Ÿæˆå›å¤ API (`POST /api/chats/[id]/generate`)ï¼š**
- å‘é€ç»™AIçš„æç¤ºè¯æ›´å®Œæ•´
- åŒ…å«è§’è‰²æè¿°ã€åˆ›ä½œè€…å¤‡æ³¨ç­‰å…³é”®ä¿¡æ¯

**é€šç”¨ç”Ÿæˆ API (`POST /api/generate`)ï¼š**
- åŒæ ·åŒ…å«å®Œæ•´çš„è§’è‰²ä¿¡æ¯
- æ·»åŠ äº† `postHistoryInstructions` æ”¯æŒ

## æ€§èƒ½å½±å“

- **Token ä½¿ç”¨é‡å¢åŠ ï¼š** çº¦ 100-500 tokensï¼ˆå–å†³äºè§’è‰²æè¿°é•¿åº¦ï¼‰
- **å“åº”æ—¶é—´ï¼š** åŸºæœ¬æ— å½±å“ï¼ˆåªæ˜¯å¢åŠ äº†è¾“å…¥å†…å®¹ï¼‰
- **æ•°æ®åº“æŸ¥è¯¢ï¼š** åˆ›å»ºå¯¹è¯æ—¶å¤šä¸€æ¬¡æ¶ˆæ¯æ’å…¥ï¼ˆä»…å½“æœ‰å¼€åœºç™½æ—¶ï¼‰

## åç»­ä¼˜åŒ–å»ºè®®

1. **é¢„è®¾æ ¼å¼æ”¯æŒï¼š**
   - å½“å‰å·²è§£æå¹¶ä¿å­˜é¢„è®¾æ ¼å¼ï¼ˆQuackAI/SillyTavernï¼‰
   - å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨é¢„è®¾ä¸­çš„ `promptList`

2. **æç¤ºè¯æ¨¡æ¿ï¼š**
   - è€ƒè™‘æ”¯æŒè‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿
   - å…è®¸ç”¨æˆ·è°ƒæ•´å­—æ®µé¡ºåºå’Œæ ¼å¼

3. **ä¸Šä¸‹æ–‡ä¼˜åŒ–ï¼š**
   - å®ç°æ™ºèƒ½æˆªæ–­ï¼Œå½“ä¸Šä¸‹æ–‡è¿‡é•¿æ—¶ä¼˜å…ˆä¿ç•™é‡è¦ä¿¡æ¯
   - ä½¿ç”¨æ»‘åŠ¨çª—å£ç®¡ç†å¯¹è¯å†å²

4. **è§’è‰²ä¸€è‡´æ€§ï¼š**
   - æ·»åŠ è§’è‰²ä¸€è‡´æ€§æ£€æŸ¥
   - ç¡®ä¿AIå›å¤ç¬¦åˆè§’è‰²è®¾å®š

## ç»“è®º

æ­¤æ¬¡ä¿®å¤è§£å†³äº†**èŠå¤©åŠŸèƒ½çš„æ ¸å¿ƒé—®é¢˜**ï¼Œç¡®ä¿AIèƒ½å¤Ÿï¼š

âœ… å‡†ç¡®ç†è§£è§’è‰²è®¾å®š
âœ… æŒ‰ç…§è§’è‰²æ€§æ ¼å’ŒèƒŒæ™¯è¿›è¡Œå›å¤
âœ… æä¾›é«˜è´¨é‡çš„è§’è‰²æ‰®æ¼”ä½“éªŒ

è¿™ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿ**å®Œç¾å¤åˆ» SillyTavern çš„å¯¹è¯è´¨é‡**ï¼Œä¸ºç”¨æˆ·æä¾›çœŸå®ã€æ²‰æµ¸çš„è§’è‰²äº’åŠ¨ä½“éªŒã€‚

---

**ä¿®å¤äººå‘˜ï¼š** Claude (AI Assistant)  
**å®¡æŸ¥çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**éƒ¨ç½²çŠ¶æ€ï¼š** ğŸŸ¡ å¾…æµ‹è¯•

