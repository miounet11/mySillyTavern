name: ğŸ” Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ğŸ·ï¸ ä¾èµ–æ£€æŸ¥
  dependency-check:
    name: ğŸ“¦ Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Audit for vulnerabilities
        run: npm audit --audit-level=moderate

      - name: ğŸ“Š Check for outdated dependencies
        run: npm outdated || true

      - name: ğŸ” Snyk security scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # ğŸ“ ä»£ç é£æ ¼æ£€æŸ¥
  code-style:
    name: ğŸ¨ Code Style
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” ESLint
        run: |
          npx eslint . --ext .ts,.tsx,.js,.jsx --format json > eslint-report.json || true
          npm run lint --if-present

      - name: ğŸ¨ Prettier check
        run: |
          npx prettier --check . --format json > prettier-report.json || true
          npm run format:check --if-present

      - name: ğŸ“Š Upload style reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: style-reports
          path: |
            eslint-report.json
            prettier-report.json

  # ğŸ—ï¸ TypeScriptæ£€æŸ¥
  typescript-check:
    name: ğŸ—ï¸ TypeScript
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Type check
        run: |
          npm run type-check --if-present
          npx tsc --noEmit --project apps/web/tsconfig.json || true

      - name: ğŸ“Š Type coverage
        run: |
          npx type-coverage --strict --detail || true

  # ğŸ“Š ä»£ç å¤æ‚åº¦åˆ†æ
  complexity-analysis:
    name: ğŸ“Š Complexity Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” CodeClimate analysis
        uses: paambaati/codeclimate-action@v5.0.0
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageLocations: coverage/lcov.info:lcov

      - name: ğŸ” SonarCloud analysis
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ğŸ“ æ–‡æ¡£æ£€æŸ¥
  documentation-check:
    name: ğŸ“– Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "âŒ README.md is missing"
            exit 1
          fi

      - name: ğŸ” Check for TODOs
        run: |
          echo "ğŸ” Searching for TODO comments..."
          grep -r "TODO\|FIXME\|HACK" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . || echo "âœ… No TODOs found"

      - name: ğŸ“Š Documentation coverage
        run: |
          echo "ğŸ“Š Analyzing documentation coverage..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡æ¡£è¦†ç›–ç‡åˆ†æ

  # ğŸš€ æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    name: âš¡ Performance Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: âš¡ Bundle size analysis
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          du -sh apps/web/.next/ || true

      - name: ğŸ“Š Compare bundle sizes
        run: |
          echo "ğŸ“Š Comparing with main branch..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ bundle sizeæ¯”è¾ƒé€»è¾‘

  # ğŸ§¹ ä»£ç æ¸…ç†æ£€æŸ¥
  cleanup-check:
    name: ğŸ§¹ Cleanup Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for unused files
        run: |
          echo "ğŸ” Checking for unused files..."
          find . -name "*.log" -o -name "*.tmp" -o -name "*.bak" | head -10 || echo "âœ… No obvious unused files"

      - name: ğŸ” Check for console.log statements
        run: |
          echo "ğŸ” Checking for console.log statements..."
          grep -r "console.log" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" apps/web/src/ | head -10 || echo "âœ… No console.log found in source files"

  # ğŸ“Š è´¨é‡æŠ¥å‘Š
  quality-report:
    name: ğŸ“Š Quality Report
    runs-on: ubuntu-latest
    needs: [dependency-check, code-style, typescript-check]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate quality report
        run: |
          echo "# ğŸ” Code Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Check**: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Style**: ${{ needs.code-style.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TypeScript**: ${{ needs.typescript-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review any failed checks" >> $GITHUB_STEP_SUMMARY
          echo "- Update dependencies if needed" >> $GITHUB_STEP_SUMMARY
          echo "- Fix any TypeScript errors" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“§ Quality notification
        if: failure()
        run: |
          echo "âŒ Quality checks failed. Please review the report."